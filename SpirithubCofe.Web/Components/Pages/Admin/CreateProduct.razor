@page "/admin/products/create"
@attribute [Authorize(Roles = "Admin")]
@inject ProductService ProductService
@inject CategoryService CategoryService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@using SpirithubCofe.Domain.Entities
@rendermode InteractiveServer

<PageTitle>Add New Product - SpirithubCofe Admin</PageTitle>

<div class="min-h-screen bg-gray-50 py-6">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Page Header -->
        <div class="bg-white shadow-sm rounded-lg border mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Add New Product</h1>
                        <p class="mt-1 text-sm text-gray-600">Create a new coffee product with comprehensive details</p>
                    </div>
                    <div class="mt-4 sm:mt-0 flex space-x-3">
                        <button type="button" @onclick="GoBack" 
                                class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            Back to Products
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="px-6">
                <nav class="flex space-x-8" aria-label="Tabs">
                    <button @onclick="@(() => SetActiveTab("basic"))" type="button"
                            class="@(activeTab == "basic" ? "border-blue-500 text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300") py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        Basic Information
                    </button>
                    <button @onclick="@(() => SetActiveTab("coffee"))" type="button"
                            class="@(activeTab == "coffee" ? "border-blue-500 text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300") py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        Coffee Details
                    </button>
                    <button @onclick="@(() => SetActiveTab("images"))" type="button"
                            class="@(activeTab == "images" ? "border-blue-500 text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300") py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        Images
                    </button>
                    <button @onclick="@(() => SetActiveTab("pricing"))" type="button"
                            class="@(activeTab == "pricing" ? "border-blue-500 text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300") py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        Pricing & Variants
                    </button>
                    <button @onclick="@(() => SetActiveTab("seo"))" type="button"
                            class="@(activeTab == "seo" ? "border-blue-500 text-blue-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300") py-4 px-1 border-b-2 font-medium text-sm whitespace-nowrap">
                        SEO & Settings
                    </button>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <form @onsubmit:preventDefault="true" class="space-y-6">
            
            <!-- Basic Information Tab -->
            @if (activeTab == "basic")
            {
                <div class="bg-white shadow-sm rounded-lg border">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Basic Information</h2>
                        <p class="text-sm text-gray-600">Product name, description, and category</p>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Product Name (EN) -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">
                                    Product Name (English) <span class="text-red-500">*</span>
                                </label>
                                <input type="text" @bind="product.Name" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="Ethiopian Yirgacheffe" required />
                            </div>

                            <!-- Product Name (AR) -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">
                                    Product Name (Arabic)
                                </label>
                                <input type="text" @bind="product.NameAr" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="يرغاشيف الإثيوبية" dir="rtl" />
                            </div>

                            <!-- SKU -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">
                                    SKU <span class="text-red-500">*</span>
                                </label>
                                <input type="text" @bind="product.Sku" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="YRG-ETH-001" required />
                            </div>

                            <!-- Category -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">
                                    Category <span class="text-red-500">*</span>
                                </label>
                                <select @bind="product.CategoryId" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                        required>
                                    <option value="">Select a category</option>
                                    @if (categories != null)
                                    {
                                        @foreach (var category in categories)
                                        {
                                            <option value="@category.Id">@category.Name</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Description (EN) -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                Description (English)
                            </label>
                            <textarea @bind="product.Description" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                      placeholder="Describe this coffee product..."></textarea>
                        </div>

                        <!-- Description (AR) -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">
                                Description (Arabic)
                            </label>
                            <textarea @bind="product.DescriptionAr" rows="4"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                      placeholder="وصف منتج القهوة..." dir="rtl"></textarea>
                        </div>

                        <!-- Product Settings -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" @bind="product.IsActive" 
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                                <label class="text-sm font-medium text-gray-700">Active Product</label>
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" @bind="product.IsFeatured" 
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                                <label class="text-sm font-medium text-gray-700">Featured Product</label>
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" @bind="product.IsDigital" 
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                                <label class="text-sm font-medium text-gray-700">Digital Product</label>
                            </div>
                        </div>

                        <!-- Additional Fields -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Tags</label>
                                <input type="text" @bind="product.Tags" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="organic, fair-trade, single-origin" />
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Origin</label>
                                <input type="text" @bind="product.Origin" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="Ethiopia" />
                            </div>
                        </div>

                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Intensity (1-10)</label>
                            <input type="number" @bind="product.Intensity" min="1" max="10"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="7" />
                        </div>
                    </div>
                </div>
            }

            <!-- Coffee Details Tab -->
            @if (activeTab == "coffee")
            {
                <div class="bg-white shadow-sm rounded-lg border">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">Coffee Details</h2>
                        <p class="text-sm text-gray-600">Specific coffee characteristics and attributes</p>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Roast Level -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Roast Level</label>
                                <select @bind="product.RoastLevel" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select roast level</option>
                                    <option value="Light">Light Roast</option>
                                    <option value="Medium-Light">Medium-Light Roast</option>
                                    <option value="Medium">Medium Roast</option>
                                    <option value="Medium-Dark">Medium-Dark Roast</option>
                                    <option value="Dark">Dark Roast</option>
                                    <option value="French">French Roast</option>
                                    <option value="Italian">Italian Roast</option>
                                </select>
                            </div>

                            <!-- Roast Level (AR) -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Roast Level (Arabic)</label>
                                <input type="text" @bind="product.RoastLevelAr" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="تحميص متوسط" dir="rtl" />
                            </div>

                            <!-- Process -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Processing Method</label>
                                <select @bind="product.Process" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Select processing method</option>
                                    <option value="Washed">Washed</option>
                                    <option value="Natural">Natural (Dry)</option>
                                    <option value="Honey">Honey Process</option>
                                    <option value="Semi-Washed">Semi-Washed</option>
                                    <option value="Wet Hulled">Wet Hulled</option>
                                </select>
                            </div>

                            <!-- Process (AR) -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Processing Method (Arabic)</label>
                                <input type="text" @bind="product.ProcessAr" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="معالجة مغسولة" dir="rtl" />
                            </div>

                            <!-- Variety -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Coffee Variety</label>
                                <input type="text" @bind="product.Variety" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="Heirloom" />
                            </div>

                            <!-- Variety (AR) -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Coffee Variety (Arabic)</label>
                                <input type="text" @bind="product.VarietyAr" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="متنوعة الإرث" dir="rtl" />
                            </div>

                            <!-- Altitude -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Altitude (meters)</label>
                                <input type="number" @bind="product.Altitude" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="1800" />
                            </div>

                            <!-- Farm -->
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Farm/Estate</label>
                                <input type="text" @bind="product.Farm" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="Yirgacheffe Coffee Farmers Cooperative" />
                            </div>
                        </div>

                        <!-- Farm (AR) -->
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">Farm/Estate (Arabic)</label>
                            <input type="text" @bind="product.FarmAr" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                   placeholder="تعاونية مزارعي قهوة يرغاشيف" dir="rtl" />
                        </div>

                        <!-- Tasting Notes -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Tasting Notes (English)</label>
                                <textarea @bind="product.TastingNotes" rows="3"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                          placeholder="Bright acidity, floral aroma, citrus notes"></textarea>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Tasting Notes (Arabic)</label>
                                <textarea @bind="product.TastingNotesAr" rows="3"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                          placeholder="حموضة مشرقة، رائحة زهرية، نكهات حمضيات" dir="rtl"></textarea>
                            </div>
                        </div>

                        <!-- Aromatic Profile -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Aromatic Profile (English)</label>
                                <input type="text" @bind="product.AromaticProfile" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="Floral, citrus, wine-like" />
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Aromatic Profile (Arabic)</label>
                                <input type="text" @bind="product.AromaticProfileAr" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="زهري، حمضيات، شبيه بالنبيذ" dir="rtl" />
                            </div>
                        </div>

                        <!-- Uses and Compatibility -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Best Uses (English)</label>
                                <textarea @bind="product.Uses" rows="2"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                          placeholder="Pour over, drip coffee, cold brew"></textarea>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Best Uses (Arabic)</label>
                                <textarea @bind="product.UsesAr" rows="2"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                          placeholder="قهوة صب، قهوة بالتنقيط، قهوة باردة" dir="rtl"></textarea>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Equipment Compatibility (English)</label>
                                <input type="text" @bind="product.Compatibility" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="V60, Chemex, French Press" />
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Equipment Compatibility (Arabic)</label>
                                <input type="text" @bind="product.CompatibilityAr" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="في60، كيمكس، فرنش بريس" dir="rtl" />
                            </div>
                        </div>

                        <!-- Brewing Instructions -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Brewing Instructions (English)</label>
                                <textarea @bind="product.BrewingInstructions" rows="3"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                          placeholder="Use 1:16 ratio, 200°F water, 3-4 minute brew time"></textarea>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Brewing Instructions (Arabic)</label>
                                <textarea @bind="product.BrewingInstructionsAr" rows="3"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                          placeholder="استخدم نسبة 1:16، ماء 93 درجة مئوية، 3-4 دقائق تحضير" dir="rtl"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Images Tab -->
            @if (activeTab == "images")
            {
                <div class="space-y-6">
                    <!-- Main Product Image -->
                    <div class="bg-white shadow-sm rounded-lg border">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-900">Main Product Image</h2>
                            <p class="text-sm text-gray-600">Primary image displayed in product listings</p>
                        </div>
                        <div class="p-6 space-y-6">
                            <FileUpload Folder="products" 
                                       FileType="image" 
                                       Prefix="product-main"
                                       @bind-CurrentFileUrl="mainImageUrl"
                                       AltText="@product.ImageAlt"
                                       OnFileUploaded="OnMainImageUploaded" />
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">Image Alt Text (English)</label>
                                    <input type="text" @bind="product.ImageAlt" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                           placeholder="Ethiopian Yirgacheffe coffee beans" />
                                </div>
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">Image Alt Text (Arabic)</label>
                                    <input type="text" @bind="product.ImageAltAr" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                           placeholder="حبوب قهوة يرغاشيف الإثيوبية" dir="rtl" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gallery Images -->
                    <div class="bg-white shadow-sm rounded-lg border">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-900">Gallery Images</h2>
                            <p class="text-sm text-gray-600">Additional product images (maximum 5)</p>
                        </div>
                        <div class="p-6 space-y-6">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                @for (int i = 0; i < galleryImages.Count; i++)
                                {
                                    int index = i; // Capture for closure
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <div class="mb-2 flex items-center justify-between">
                                            <span class="text-sm font-medium text-gray-700">Gallery Image @(index + 1)</span>
                                            @if (!string.IsNullOrEmpty(galleryImages[index]))
                                            {
                                                <button type="button" @onclick="() => RemoveGalleryImage(index)" 
                                                        class="text-red-600 hover:text-red-800 text-sm">
                                                    Remove
                                                </button>
                                            }
                                        </div>
                                        <FileUpload Folder="products" 
                                                   FileType="image" 
                                                   Prefix="@($"product-gallery-{index}")"
                                                   @bind-CurrentFileUrl="galleryImages[index]"
                                                   OnFileUploaded="@((result) => OnGalleryImageUploaded(index, result))" />
                                    </div>
                                }
                            </div>
                            
                            @if (galleryImages.Count < 5)
                            {
                                <div class="text-center">
                                    <button type="button" @onclick="AddGalleryImageSlot" 
                                            class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        Add Gallery Image (@galleryImages.Count/5)
                                    </button>
                                </div>
                            }
                            
                            <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                                <p class="text-sm text-blue-700">💡 Add up to 5 high-quality images showing different angles and details of your coffee product.</p>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Pricing & Variants Tab -->
            @if (activeTab == "pricing")
            {
                <div class="space-y-6">
                    <!-- Base Pricing (if no variants) -->
                    <div class="bg-white shadow-sm rounded-lg border">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h2 class="text-lg font-semibold text-gray-900">Base Pricing</h2>
                            <p class="text-sm text-gray-600">Default pricing when no variants are defined</p>
                        </div>
                        <div class="p-6 space-y-6">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">
                                        Base Price (OMR) <span class="text-red-500">*</span>
                                    </label>
                                    <input type="number" @bind="basePrice" step="0.001" min="0"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                           placeholder="5.250" />
                                </div>
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">Discount Price (OMR)</label>
                                    <input type="number" @bind="baseDiscountPrice" step="0.001" min="0"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                           placeholder="4.500" />
                                </div>
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">Base Weight (g)</label>
                                    <input type="number" @bind="baseWeight" min="0"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                           placeholder="250" />
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">Stock Quantity</label>
                                    <input type="number" @bind="baseStockQuantity" min="0"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                           placeholder="100" />
                                </div>
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">Low Stock Threshold</label>
                                    <input type="number" @bind="baseLowStockThreshold" min="0"
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                           placeholder="5" />
                                </div>
                            </div>

                            <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
                                <p class="text-sm text-blue-700">💡 Base pricing will be used if no variants are defined. Add variants below for different weights/sizes.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Product Variants -->
                    <div class="bg-white shadow-sm rounded-lg border">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-lg font-semibold text-gray-900">Product Variants</h2>
                                    <p class="text-sm text-gray-600">Different weights, sizes, and pricing options</p>
                                </div>
                                <button type="button" @onclick="AddVariant" 
                                        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                    </svg>
                                    Add Variant
                                </button>
                            </div>
                        </div>
                        <div class="p-6 space-y-6">
                            @if (productVariants.Any())
                            {
                                @foreach (var variant in productVariants.Select((v, i) => new { Variant = v, Index = i }))
                                {
                                    <div class="border border-gray-200 rounded-lg p-6 space-y-6">
                                        <div class="flex items-center justify-between">
                                            <h3 class="text-lg font-medium text-gray-900">Variant @(variant.Index + 1)</h3>
                                            <button type="button" @onclick="() => RemoveVariant(variant.Index)" 
                                                    class="text-red-600 hover:text-red-800 text-sm">
                                                Remove
                                            </button>
                                        </div>

                                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
                                            <div class="space-y-2">
                                                <label class="block text-sm font-medium text-gray-700">
                                                    Variant SKU <span class="text-red-500">*</span>
                                                </label>
                                                <input type="text" @bind="variant.Variant.VariantSku" 
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                       placeholder="YRG-ETH-250G" />
                                            </div>
                                            <div class="space-y-2">
                                                <label class="block text-sm font-medium text-gray-700">
                                                    Weight <span class="text-red-500">*</span>
                                                </label>
                                                <input type="number" @bind="variant.Variant.Weight" min="0" step="0.1"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                       placeholder="250" />
                                            </div>
                                            <div class="space-y-2">
                                                <label class="block text-sm font-medium text-gray-700">Unit</label>
                                                <select @bind="variant.Variant.WeightUnit" 
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                    <option value="g">Grams (g)</option>
                                                    <option value="kg">Kilograms (kg)</option>
                                                    <option value="oz">Ounces (oz)</option>
                                                    <option value="lb">Pounds (lb)</option>
                                                </select>
                                            </div>
                                            <div class="flex items-center space-x-3 pt-6">
                                                <input type="checkbox" @bind="variant.Variant.IsDefault" 
                                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                                                <label class="text-sm font-medium text-gray-700">Default Variant</label>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                            <div class="space-y-2">
                                                <label class="block text-sm font-medium text-gray-700">
                                                    Price (OMR) <span class="text-red-500">*</span>
                                                </label>
                                                <input type="number" @bind="variant.Variant.Price" step="0.001" min="0"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                       placeholder="5.250" />
                                            </div>
                                            <div class="space-y-2">
                                                <label class="block text-sm font-medium text-gray-700">Discount Price (OMR)</label>
                                                <input type="number" @bind="variant.Variant.DiscountPrice" step="0.001" min="0"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                       placeholder="4.500" />
                                            </div>
                                            <div class="space-y-2">
                                                <label class="block text-sm font-medium text-gray-700">Display Order</label>
                                                <input type="number" @bind="variant.Variant.DisplayOrder" min="0"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                       placeholder="@(variant.Index)" />
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                            <div class="space-y-2">
                                                <label class="block text-sm font-medium text-gray-700">Stock Quantity</label>
                                                <input type="number" @bind="variant.Variant.StockQuantity" min="0"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                       placeholder="100" />
                                            </div>
                                            <div class="space-y-2">
                                                <label class="block text-sm font-medium text-gray-700">Low Stock Threshold</label>
                                                <input type="number" @bind="variant.Variant.LowStockThreshold" min="0"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                       placeholder="5" />
                                            </div>
                                        </div>

                                        <!-- Dimensions -->
                                        <div class="border-t border-gray-200 pt-4">
                                            <h4 class="text-sm font-medium text-gray-900 mb-4">Dimensions (Optional)</h4>
                                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                                <div class="space-y-2">
                                                    <label class="block text-sm font-medium text-gray-700">Length (cm)</label>
                                                    <input type="number" @bind="variant.Variant.Length" step="0.1" min="0"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                           placeholder="10.5" />
                                                </div>
                                                <div class="space-y-2">
                                                    <label class="block text-sm font-medium text-gray-700">Width (cm)</label>
                                                    <input type="number" @bind="variant.Variant.Width" step="0.1" min="0"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                           placeholder="8.0" />
                                                </div>
                                                <div class="space-y-2">
                                                    <label class="block text-sm font-medium text-gray-700">Height (cm)</label>
                                                    <input type="number" @bind="variant.Variant.Height" step="0.1" min="0"
                                                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                                           placeholder="15.0" />
                                                </div>
                                            </div>
                                        </div>

                                        <div class="flex items-center space-x-3">
                                            <input type="checkbox" @bind="variant.Variant.IsActive" 
                                                   class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                                            <label class="text-sm font-medium text-gray-700">Active Variant</label>
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-center py-8">
                                    <div class="text-gray-500 mb-4">
                                        <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10"></path>
                                        </svg>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-4">No variants defined yet. Add variants for different weights or sizes.</p>
                                    <button type="button" @onclick="AddVariant" 
                                            class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                        Add Your First Variant
                                    </button>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- SEO & Settings Tab -->
            @if (activeTab == "seo")
            {
                <div class="bg-white shadow-sm rounded-lg border">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-900">SEO & Advanced Settings</h2>
                        <p class="text-sm text-gray-600">Search engine optimization and additional settings</p>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Meta Keywords</label>
                                <input type="text" @bind="product.MetaKeywords" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="coffee, ethiopian, yirgacheffe, organic" />
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">URL Slug</label>
                                <input type="text" @bind="product.Slug" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="ethiopian-yirgacheffe-coffee" />
                            </div>
                        </div>

                        <!-- Certifications -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" @bind="product.IsOrganic" 
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                                <label class="text-sm font-medium text-gray-700">🌱 Organic Certified</label>
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" @bind="product.IsFairTrade" 
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                                <label class="text-sm font-medium text-gray-700">🤝 Fair Trade Certified</label>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Product Launch Date</label>
                                <input type="date" @bind="product.LaunchDate" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Sort Order</label>
                                <input type="number" @bind="product.SortOrder" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                       placeholder="0" />
                                <p class="text-xs text-gray-500">Lower numbers appear first</p>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Expiry/Best Before</label>
                                <input type="date" @bind="product.ExpiryDate" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" />
                            </div>
                        </div>

                        <!-- Internal Notes -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Internal Notes (English)</label>
                                <textarea @bind="product.Notes" rows="3"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                          placeholder="Internal notes for staff only..."></textarea>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-medium text-gray-700">Internal Notes (Arabic)</label>
                                <textarea @bind="product.NotesAr" rows="3"
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" 
                                          placeholder="ملاحظات داخلية للموظفين فقط..." dir="rtl"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Action Buttons -->
            <div class="bg-white shadow-sm rounded-lg border">
                <div class="px-6 py-4">
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0">
                        <div class="text-sm text-gray-600">
                            Review all information before saving the product.
                        </div>
                        <div class="flex space-x-3">
                            <button type="button" @onclick="SaveAsDraft" disabled="@saving"
                                    class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 disabled:opacity-50">
                                @if (saving)
                                {
                                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                }
                                Save as Draft
                            </button>
                            <button type="button" @onclick="SaveProduct" disabled="@saving"
                                    class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50">
                                @if (saving)
                                {
                                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                }
                                Save & Publish
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

@code {
    private Product product = new() { IsActive = true };
    private List<Category>? categories;
    private bool saving = false;
    private string activeTab = "basic";
    private List<string?> galleryImages = new() { null }; // Start with one empty slot
    private string? mainImageUrl; // URL for the main product image

    // Base pricing (when no variants)
    private decimal? basePrice;
    private decimal? baseDiscountPrice;
    private decimal? baseWeight;
    private int? baseStockQuantity;
    private int baseLowStockThreshold = 5;

    // Product variants
    private List<ProductVariant> productVariants = new();

    protected override async Task OnInitializedAsync()
    {
        categories = await CategoryService.GetAllCategoriesAsync();
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/admin/products");
    }

    // Variant methods
    private void AddVariant()
    {
        var newVariant = new ProductVariant
        {
            WeightUnit = "g",
            IsActive = true,
            DisplayOrder = productVariants.Count,
            LowStockThreshold = 5
        };
        
        productVariants.Add(newVariant);
        StateHasChanged();
    }

    private void RemoveVariant(int index)
    {
        if (index >= 0 && index < productVariants.Count)
        {
            productVariants.RemoveAt(index);
            
            // Update display orders
            for (int i = 0; i < productVariants.Count; i++)
            {
                productVariants[i].DisplayOrder = i;
            }
            
            StateHasChanged();
        }
    }

    // Gallery methods
    private void AddGalleryImageSlot()
    {
        if (galleryImages.Count < 5)
        {
            galleryImages.Add(null);
            StateHasChanged();
        }
    }

    private void RemoveGalleryImage(int index)
    {
        if (index >= 0 && index < galleryImages.Count)
        {
            galleryImages.RemoveAt(index);
            StateHasChanged();
        }
    }

    // File upload handlers
    private void OnMainImageUploaded(FileUpload.UploadResult result)
    {
        if (result.Success)
        {
            mainImageUrl = result.FileUrl;
            
            // Create or update the main image
            product.MainImage = new SpirithubCofe.Domain.Entities.ProductImage
            {
                FileName = result.FileName,
                ImagePath = result.FileUrl,
                AltText = product.ImageAlt,
                AltTextAr = product.ImageAltAr,
                IsMain = true,
                FileSize = result.FileSize,
                CreatedAt = DateTime.UtcNow
            };
            
            StateHasChanged();
        }
    }

    private void OnGalleryImageUploaded(int index, FileUpload.UploadResult result)
    {
        if (result.Success && index >= 0 && index < galleryImages.Count)
        {
            galleryImages[index] = result.FileUrl;
            
            // Create gallery image entity
            var galleryImage = new SpirithubCofe.Domain.Entities.ProductImage
            {
                FileName = result.FileName,
                ImagePath = result.FileUrl,
                IsMain = false,
                DisplayOrder = index,
                FileSize = result.FileSize,
                CreatedAt = DateTime.UtcNow
            };

            // Add to product gallery if not already exists
            if (!product.GalleryImages.Any(gi => gi.DisplayOrder == index))
            {
                product.GalleryImages.Add(galleryImage);
            }
            else
            {
                // Update existing gallery image
                var existing = product.GalleryImages.FirstOrDefault(gi => gi.DisplayOrder == index);
                if (existing != null)
                {
                    existing.FileName = result.FileName;
                    existing.ImagePath = result.FileUrl;
                    existing.FileSize = result.FileSize;
                    existing.CreatedAt = DateTime.UtcNow;
                }
            }
            
            StateHasChanged();
        }
    }

    private async Task SaveProduct()
    {
        saving = true;
        try
        {
            // Generate slug if empty
            if (string.IsNullOrEmpty(product.Slug))
            {
                product.Slug = GenerateSlug(product.Name);
            }

            // Handle pricing - if variants exist, use them; otherwise create base variant
            if (productVariants.Any())
            {
                // Assign variants to product
                foreach (var variant in productVariants)
                {
                    variant.ProductId = product.Id;
                    product.Variants.Add(variant);
                }
            }
            else if (basePrice.HasValue)
            {
                // Create a default variant from base pricing
                var defaultVariant = new ProductVariant
                {
                    VariantSku = product.Sku + "-DEFAULT",
                    Weight = baseWeight ?? 0,
                    WeightUnit = "g",
                    Price = basePrice.Value,
                    DiscountPrice = baseDiscountPrice,
                    StockQuantity = baseStockQuantity ?? 0,
                    LowStockThreshold = baseLowStockThreshold,
                    IsActive = true,
                    IsDefault = true,
                    DisplayOrder = 0,
                    ProductId = product.Id
                };
                product.Variants.Add(defaultVariant);
            }

            var createdProduct = await ProductService.CreateProductAsync(product);
            
            await JSRuntime.InvokeVoidAsync("alert", "Product created successfully!");
            Navigation.NavigateTo($"/admin/products");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error creating product: {ex.Message}");
        }
        finally
        {
            saving = false;
        }
    }

    private async Task SaveAsDraft()
    {
        product.IsActive = false;
        await SaveProduct();
    }

    private string GenerateSlug(string name)
    {
        if (string.IsNullOrEmpty(name)) return string.Empty;
        
        return name.ToLowerInvariant()
                  .Replace(" ", "-")
                  .Replace("&", "and")
                  .Replace("--", "-")
                  .Trim('-');
    }
}