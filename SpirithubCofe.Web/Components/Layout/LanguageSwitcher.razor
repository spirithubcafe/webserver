@using System.Globalization
@inject NavigationManager Navigation
@inject ILogger<LanguageSwitcher> Logger
@rendermode InteractiveServer

<div class="language-switcher">
    <details class="dropdown" data-theme="light">
        <summary class="btn btn-sm bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-normal">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"/>
            </svg>
            @if (_selectedCulture == "ar")
            {
                <span>العربية</span>
            }
            else
            {
                <span>English</span>
            }
        </summary>
        <ul class="menu dropdown-content bg-base-100 rounded-box z-[1] w-52 p-2 shadow-lg border border-gray-200">
            <li>
                <a @onclick="@(() => ChangeLanguage("en"))" 
                   class="@GetMenuItemClass("en")">
                     English
                    @if (_selectedCulture == "en")
                    {
                        <svg class="w-4 h-4 ml-auto text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    }
                </a>
            </li>
            <li>
                <a @onclick="@(() => ChangeLanguage("ar"))" 
                   class="@GetMenuItemClass("ar")">
                     العربية
                    @if (_selectedCulture == "ar")
                    {
                        <svg class="w-4 h-4 ml-auto text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    }
                </a>
            </li>
        </ul>
    </details>
</div>

@code {
    private string _selectedCulture = "en";

    private void ChangeLanguage(string culture)
    {
        if (_selectedCulture == culture || string.IsNullOrWhiteSpace(culture)) return;
        
        _selectedCulture = culture;
        Logger.LogInformation("Language changed to: {Culture}", culture);

        var currentUri = new Uri(Navigation.Uri);
        var returnUrl = currentUri.PathAndQuery;

        var url = $"/Culture/Set?culture={culture}&returnUrl={Uri.EscapeDataString(returnUrl)}";
        Navigation.NavigateTo(url, forceLoad: true);
    }

    private string GetMenuItemClass(string culture)
    {
        return _selectedCulture == culture 
            ? "active bg-orange-100 text-orange-700" 
            : "hover:bg-gray-100";
    }

    protected override void OnInitialized()
    {
        var culture = CultureInfo.CurrentUICulture.Name;
        _selectedCulture = culture.StartsWith("ar") ? "ar" : "en";
    }
}
